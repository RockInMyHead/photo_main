# Face Sorter — Мини‑проводник

Приложение для сортировки фотографий по лицам с использованием Streamlit.

## Структура проекта после рефакторинга

Проект был разбит на модули для лучшей организации кода:

### Основные модули:

1. **`config.py`** - Конфигурация приложения
   - Класс `AppConfig` с настройками
   - Функции загрузки и валидации конфигурации

2. **`utils.py`** - Общие утилиты
   - Работа с файлами (`ensure_dir`, `safe_copy`, `safe_move`)
   - Логирование (`log`)
   - Сетевые функции (`get_lan_ip`, `get_network_url`)
   - Выбор папки (`pick_folder_dialog`)

3. **`cache.py`** - Кеширование
   - `get_thumb_bytes` - кеширование миниатюр изображений
   - `get_yolo_model` - кеширование YOLO моделей
   - `yolo_people_count_cached` - кеширование подсчета людей

4. **`session.py`** - Управление состоянием Streamlit
   - Класс `S` с ключами состояния
   - `init_state` - инициализация состояния

5. **`utils.py`** - Общие утилиты (расширенная версия)
   - `list_dir` - получение списка файлов/папок
   - `human_size` - форматирование размера файлов
   - `safe_copy`/`safe_move` - безопасное копирование/перемещение
   - `log` - логирование
   - Сетевые функции и диалог выбора папки

6. **`index.py`** - Работа с глобальным индексом
   - `load_index` - загрузка глобального индекса
   - `save_index` - сохранение глобального индекса

7. **`person_index.py`** - Работа с индексом персон
   - `load_person_index` - загрузка индекса персон с миграцией
   - `save_person_index` - сохранение индекса персон

8. **`processing.py`** - Основная логика обработки
   - `match_and_apply` - сопоставление кластеров с персонами
   - `cleanup_processed_images` - очистка обработанных изображений
   - `process_targets` - основная функция обработки

9. **`ui_components.py`** - Компоненты интерфейса
   - `render_topbar` - верхняя панель навигации
   - `render_filters_and_options` - фильтры и настройки
   - `render_explorer` - файловый проводник
   - `render_move_panel` - панель перемещения файлов
   - `render_footer_queue` - нижняя панель с очередью

10. **`main.py`** - Точка входа приложения
    - Главная функция `main`
    - Конфигурация страницы Streamlit

## Запуск приложения

```bash
streamlit run main.py
```

## Зависимости

Основные зависимости:
- streamlit
- numpy
- pillow (PIL)
- ultralytics (опционально, для YOLO)
- streamlit-sortables (опционально, для drag & drop)
- Send2Trash (опционально, для безопасного удаления)

### Установка YOLO (опционально)

Для использования функций детекции людей установите ultralytics:

```bash
pip install ultralytics
```

Для предварительной загрузки моделей YOLO (чтобы избежать задержек при первом использовании):

```bash
python download_yolo.py
```

**Примечание**: При первом использовании YOLO будет автоматически загружать модели из интернета (~6-50MB в зависимости от модели).

## Конфигурация

Настройки хранятся в файле `config.json` в корневой папке проекта.

## Цели рефакторинга

- ✅ Чёткая слойность (Config / Caching / FS / UI / Pipeline)
- ✅ Типизация и dataclass-конфиг
- ✅ Меньше глобалей; единые точки входа
- ✅ Переиспользуемые UI‑компоненты
- ✅ YOLO‑гейтинг параметризован и прокинут в build_plan

